import os

# Define the directory where your test files are located
test_dir = '/Users/yukachen/marketing-operation/serviceable-addressable-market-list/hiring-post-quality-check/.venv/lib/python3.10/site-packages/IPython/core/tests/'

# Add the necessary imports and ip definition
def fix_test_file(file_path):
    try:
        # Attempt to open the file with utf-8 encoding
        with open(file_path, 'r', encoding='utf-8') as f:
            lines = f.readlines()
    except UnicodeDecodeError:
        # If utf-8 fails, try using ISO-8859-1 encoding
        with open(file_path, 'r', encoding='ISO-8859-1') as f:
            lines = f.readlines()

    # Check if the file already contains the necessary imports and definition
    has_get_ipython_import = any('from IPython import get_ipython' in line for line in lines)
    has_ip_definition = any('ip = get_ipython()' in line for line in lines)

    if not has_get_ipython_import:
        # Add the import at the top
        lines.insert(0, 'from IPython import get_ipython\n')

    # Check if any 'ip' is referenced and add definition if missing
    if any('ip' in line for line in lines) and not has_ip_definition:
        # Insert the ip definition after the imports
        lines.insert(1, 'ip = get_ipython()\n')

    # Write back the modified lines
    with open(file_path, 'w', encoding='utf-8') as f:
        f.writelines(lines)

# Iterate over all test files and apply the fix
for root, dirs, files in os.walk(test_dir):
    for file in files:
        if file.endswith('.py'):
            fix_test_file(os.path.join(root, file))
